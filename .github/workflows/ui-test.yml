name: Selenium Cucumber UI Test

on:
  workflow_dispatch:

jobs:
  ui-test:
    runs-on: ubuntu-latest

    # gh-pages push Í∂åÌïú ÌïÑÏàò
    permissions:
      contents: write

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'

      # ChromeÏùÄ ubuntu-latestÏóê Í∏∞Î≥∏ ÏÑ§ÏπòÎêòÏñ¥ ÏûàÏúºÎÇò
      # Î™ÖÏãúÏ†ÅÏúºÎ°ú Ïú†ÏßÄ (ÏöîÏ≤≠ Î∞òÏòÅ)
      - name: Install Chrome
        uses: browser-actions/setup-chrome@v1

      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            maven-

      # ===============================
      # ÌÖåÏä§Ìä∏ Ïã§Ìñâ + HTML Î¶¨Ìè¨Ìä∏ ÏÉùÏÑ±
      # ===============================
      - name: Run Selenium Cucumber tests
        run: mvn clean verify -Dcucumber.filter.tags="@smoke" \
          -Dbuild.number=${{ github.run_number }}

      # ===============================
      # Artifact ÏóÖÎ°úÎìú (ÏÑ†ÌÉùÏù¥ÏßÄÎßå Ïú†ÏßÄ)
      # ===============================
      - name: Upload Cucumber Report Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cucumber-report
          path: target

      # ===============================
      # Summary (Scenario Í∏∞Ï§Ä ÌÜµÍ≥Ñ)
      # ===============================
      - name: Generate Cucumber Summary
        if: always()
        run: |
          PASSED=$(jq '[.[] | .elements[] | select(.status=="passed")] | length' target/cucumber-report.json)
          FAILED=$(jq '[.[] | .elements[] | select(.status=="failed")] | length' target/cucumber-report.json)

          echo "### Cucumber Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÑ Full HTML Report:" >> $GITHUB_STEP_SUMMARY
          echo "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY

      # GitHub Pages Î∞∞Ìè¨
      - name: Deploy Cucumber Report to GitHub Pages
        if: always()
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: target/
