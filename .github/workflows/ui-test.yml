name: Selenium Cucumber UI Test

on:
        workflow_dispatch:

jobs:
        ui-test:
                runs-on: ubuntu-latest

                steps:
                        - name: Checkout source
                          uses: actions/checkout@v4

                        - name: Set up JDK
                          uses: actions/setup-java@v4
                          with:
                                  distribution: 'temurin'
                                  java-version: '11'

                        - name: Install Chrome
                          uses: browser-actions/setup-chrome@v1

                        - name: Cache Maven dependencies
                          uses: actions/cache@v4
                          with:
                                  path: ~/.m2
                                  key: maven-${{ hashFiles('**/pom.xml') }}
                                  restore-keys: |
                                          maven-

                        - name: Run Selenium Cucumber tests
                          run: |
                                  mvn clean test -Dcucumber.filter.tags="@smoke"

                        - name: Upload Cucumber Report
                          if: always()
                          uses: actions/upload-artifact@v4
                          with:
                                  name: cucumber-report
                                  path: target

                        - name: Generate Cucumber Summary
                          if: always()
                          run: |
                                PASSED=$(jq '[.features[].elements[].steps[] | select(.result.status=="passed")] | length' target/cucumber-report.json)
                                FAILED=$(jq '[.features[].elements[].steps[] | select(.result.status=="failed")] | length' target/cucumber-report.json)
                  
                                  echo "### Cucumber Test Summary" >> $GITHUB_STEP_SUMMARY
                                  echo "" >> $GITHUB_STEP_SUMMARY
                                  echo "| Status | Count |" >> $GITHUB_STEP_SUMMARY
                                  echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
                                  echo "| Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
                                  echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
                                  echo "" >> $GITHUB_STEP_SUMMARY
                                  echo "ðŸ“„ Full HTML Report: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY

                        - name: Deploy Cucumber Report to GitHub Pages
                          if: always()
                          uses: peaceiris/actions-gh-pages@v4
                          with:
                                  github_token: ${{ secrets.GITHUB_TOKEN }}
                                  publish_branch: gh-pages
                                  publish_dir: target/cucumber-html